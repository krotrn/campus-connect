// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

generator worker {
  provider = "prisma-client-js"
  output   = "../workers/generated/client"
}

datasource db {
  provider = "postgresql"
}

// ----------------------------------------
// Enums & Custom Types
// ----------------------------------------

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  NEW
  BATCHED
  OUT_FOR_DELIVERY
  COMPLETED
  CANCELLED
}

enum SellerVerificationStatus {
  NOT_STARTED
  PENDING
  REQUIRES_ACTION
  VERIFIED
  REJECTED
}

enum PaymentMethod {
  CASH
  ONLINE
}

enum PayoutStatus {
  PENDING
  IN_TRANSIT
  PAID
  FAILED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum AdminAction {
  SHOP_VERIFY
  SHOP_REJECT
  SHOP_ACTIVATE
  SHOP_DEACTIVATE
  SHOP_DELETE
  USER_MAKE_ADMIN
  USER_REMOVE_ADMIN
  USER_SUSPEND
  USER_UNSUSPEND
  USER_DELETE
  USER_FORCE_SIGNOUT
  BROADCAST_CREATE
  ORDER_STATUS_OVERRIDE
}

enum BatchStatus {
  OPEN
  LOCKED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

// ----------------------------------------
// Batch Scheduling Models
// ----------------------------------------

model BatchSlot {
  id String @id @default(cuid())

  shop_id String
  shop    Shop   @relation(fields: [shop_id], references: [id], onDelete: Cascade)

  // Minutes from midnight (0-1439) representing the daily batch cutoff time.
  cutoff_time_minutes Int
  label               String? // Optional display label (e.g. "5 PM Batch")
  is_active           Boolean @default(true)
  sort_order          Int     @default(0)

  batches Batch[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([shop_id, cutoff_time_minutes, label])
  @@index([shop_id])
  @@index([shop_id, is_active])
  @@map("batch_slot")
}

// ----------------------------------------
// Auth Models (for NextAuth.js)
// ----------------------------------------

model User {
  id               String     @id @default(cuid())
  email            String
  emailVerified    Boolean    @default(false)
  name             String
  phone            String?
  image            String?
  role             Role       @default(USER)
  status           UserStatus @default(ACTIVE)
  suspended_at     DateTime?
  suspended_reason String?
  shop_id          String?    @unique
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // Relations
  sessions                Session[]
  accounts                Account[]
  owned_shop              Shop?                 @relation("owned_shop", fields: [shop_id], references: [id], onDelete: Restrict)
  reviews                 Review[]
  carts                   Cart[]
  orders                  Order[]
  addresses               UserAddress[]
  notification            Notification[]
  broadcast_read_statuses BroadcastReadStatus[]
  favorite_shops          FavoriteShop[]
  stock_watches           StockWatch[]

  @@unique([email])
  @@index([role])
  @@index([status])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

// ----------------------------------------
// Core Business Models
// ----------------------------------------

model Shop {
  id                  String                   @id @default(cuid())
  name                String
  description         String
  location            String
  opening             String
  closing             String
  image_key           String
  upi_id              String
  qr_image_key        String
  is_active           Boolean                  @default(false)
  accepting_orders    Boolean                  @default(true)
  pg_seller_id        String?                  @unique
  verification_status SellerVerificationStatus @default(NOT_STARTED)
  deleted_at          DateTime?
  created_at          DateTime                 @default(now())
  updated_at          DateTime                 @updatedAt

  min_order_value       Decimal @default(50.00) @db.Decimal(10, 2)
  default_delivery_fee  Decimal @default(0) @db.Decimal(10, 2)
  direct_delivery_fee   Decimal @default(0) @db.Decimal(10, 2)

  products     Product[]
  orders       Order[]
  payouts      Payout[]
  carts        Cart[]
  categories   Category[]
  batches      Batch[]
  batch_slots  BatchSlot[]
  user         User?          @relation("owned_shop")
  favorited_by FavoriteShop[]

  @@index([verification_status])
  @@index([deleted_at])
}

model Category {
  id   String @id @default(cuid())
  name String

  // Relations
  shop_id  String
  shop     Shop      @relation(fields: [shop_id], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([shop_id, name])
}

model Product {
  id             String    @id @default(cuid())
  name           String
  description    String?
  price          Decimal
  discount       Decimal?
  stock_quantity Int       @default(0)
  rating_sum     Int       @default(0)
  review_count   Int       @default(0)
  image_key      String
  deleted_at     DateTime?
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  // Relations
  shop_id       String
  shop          Shop         @relation(fields: [shop_id], references: [id], onDelete: Cascade)
  category_id   String?
  category      Category?    @relation(fields: [category_id], references: [id], onDelete: SetNull)
  reviews       Review[]
  cartItems     CartItem[]
  orderItems    OrderItem[]
  stock_watches StockWatch[]

  @@index([shop_id])
  @@index([category_id])
  @@index([deleted_at])
}

// ----------------------------------------
// User Interaction Models
// ----------------------------------------

model UserAddress {
  id           String   @id @default(cuid())
  label        String
  hostel_block String?
  building     String
  room_number  String
  notes        String?
  is_default   Boolean  @default(false)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  // Relations
  user_id String
  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  orders  Order[]

  @@index([user_id])
  @@index([hostel_block])
}

model Cart {
  id String @id @default(cuid())

  // Relations
  user_id String
  user    User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  shop_id String
  shop    Shop       @relation(fields: [shop_id], references: [id], onDelete: Cascade)
  items   CartItem[]

  @@unique([user_id, shop_id])
}

model CartItem {
  id       String @id @default(cuid())
  quantity Int

  // Relations
  cart_id    String
  cart       Cart    @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  product_id String
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([cart_id, product_id])
  @@index([cart_id])
}

model Review {
  id         String   @id @default(cuid())
  rating     Int
  comment    String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  user_id       String
  user          User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  product_id    String
  product       Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)
  order_item    OrderItem @relation(fields: [order_item_id], references: [id])
  order_item_id String    @unique

  @@index([product_id])
  @@index([user_id])
}

// ----------------------------------------
// Transactional & Financial Models
// ----------------------------------------

model Order {
  id         String @id @default(cuid())
  display_id String @unique

  item_total   Decimal @db.Decimal(10, 2)
  delivery_fee Decimal @default(0) @db.Decimal(10, 2)
  platform_fee Decimal @default(0) @db.Decimal(10, 2)
  total_price  Decimal @db.Decimal(10, 2)

  payment_method            PaymentMethod
  payment_status            PaymentStatus @default(PENDING)
  order_status              OrderStatus   @default(NEW)
  pg_payment_id             String?       @unique
  pg_refund_id              String?       @unique
  upi_transaction_id        String?
  delivery_address_snapshot String
  requested_delivery_time   DateTime?
  estimated_delivery_time   DateTime?
  actual_delivery_time      DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  assigned_to        String?
  customer_notes     String?
  delivery_otp       String?
  is_direct_delivery Boolean @default(false)

  // Relations
  user_id             String?
  user                User?        @relation(fields: [user_id], references: [id], onDelete: SetNull)
  shop_id             String?
  shop                Shop?        @relation(fields: [shop_id], references: [id], onDelete: SetNull)
  batch_id            String?
  batch               Batch?       @relation(fields: [batch_id], references: [id])
  items               OrderItem[]
  delivery_address_id String?
  delivery_address    UserAddress? @relation(fields: [delivery_address_id], references: [id], onDelete: SetNull)

  @@index([user_id])
  @@index([shop_id])
  @@index([batch_id])
  @@index([order_status])
  @@index([payment_status])
}

model OrderItem {
  id       String  @id @default(cuid())
  quantity Int
  price    Decimal

  // Relations
  order_id   String
  order      Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product_id String
  product    Product @relation(fields: [product_id], references: [id], onDelete: Restrict)
  review     Review?

  @@index([order_id])
}

model Payout {
  id           String       @id @default(cuid())
  amount       Decimal
  status       PayoutStatus @default(PENDING)
  pg_payout_id String       @unique
  arrival_date DateTime
  created_at   DateTime     @default(now())

  // Relations
  shop_id String?
  shop    Shop?   @relation(fields: [shop_id], references: [id], onDelete: SetNull)

  @@index([shop_id])
  @@index([status])
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum NotificationCategory {
  GENERAL
  ORDER
  SYSTEM
  ANNOUNCEMENT
}

model Notification {
  id         String               @id @default(cuid())
  user_id    String
  title      String
  message    String
  type       NotificationType     @default(INFO)
  action_url String?
  category   NotificationCategory @default(GENERAL)
  read       Boolean              @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("notification")
}

model BroadcastNotification {
  id         String               @id @default(cuid())
  title      String
  message    String
  type       NotificationType     @default(INFO)
  action_url String?
  category   NotificationCategory @default(GENERAL)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  read_statuses BroadcastReadStatus[]

  @@index([created_at])
  @@map("broadcast_notification")
}

model BroadcastReadStatus {
  id                        String   @id @default(cuid())
  user_id                   String
  broadcast_notification_id String
  read_at                   DateTime @default(now())

  user                  User                  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  broadcastNotification BroadcastNotification @relation(fields: [broadcast_notification_id], references: [id], onDelete: Cascade)

  @@unique([user_id, broadcast_notification_id])
  @@index([user_id])
}

// ----------------------------------------
// Logistics Models
// ----------------------------------------

model Batch {
  id String @id @default(cuid())

  shop_id String
  shop    Shop   @relation(fields: [shop_id], references: [id], onDelete: Cascade)

  slot_id String?
  slot    BatchSlot? @relation(fields: [slot_id], references: [id], onDelete: SetNull)

  cutoff_time DateTime
  status      BatchStatus @default(OPEN)

  orders Order[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([shop_id])
  @@index([cutoff_time])
  @@index([status])
  @@index([slot_id])
}

// ----------------------------------------
// Admin & System Models
// ----------------------------------------

model AdminAuditLog {
  id          String      @id @default(cuid())
  admin_id    String
  action      AdminAction
  target_type String
  target_id   String
  details     Json?
  ip_address  String?
  user_agent  String?
  created_at  DateTime    @default(now())

  @@index([admin_id])
  @@index([target_type, target_id])
  @@index([created_at])
  @@map("admin_audit_log")
}

model FavoriteShop {
  id         String   @id @default(cuid())
  user_id    String
  shop_id    String
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  shop Shop @relation(fields: [shop_id], references: [id], onDelete: Cascade)

  @@unique([user_id, shop_id])
  @@index([user_id])
  @@map("favorite_shop")
}

model StockWatch {
  id         String   @id @default(cuid())
  user_id    String
  product_id String
  created_at DateTime @default(now())

  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([user_id, product_id])
  @@index([user_id])
  @@map("stock_watch")
}

// ----------------------------------------
// Platform Settings (Global Admin Config)
// ----------------------------------------

model PlatformSettings {
  id           String   @id @default("default")
  platform_fee Decimal  @default(0) @db.Decimal(10, 2)
  updated_at   DateTime @updatedAt

  @@map("platform_settings")
}
